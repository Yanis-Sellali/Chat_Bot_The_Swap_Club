<div class="ai-chat-box container my-5">
  <h1 class="text-center mb-4">TheSwapClub AI</h1>

  <% if flash[:alert] %>
    <div class="alert alert-danger">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <div class="chat-thread mb-5" id="chat-thread">
    <% @chat.messages.each do |message| %>
      <div class="chat-message <%= message.role == "user" ? "from-user" : "from-ai" %> animate-fade-in mb-3 p-3 rounded shadow-sm">
        <strong><%= message.role.capitalize %> :</strong><br />
        <%= markdown(message.content) %>
        <% if message.image.attached? %>
          <div class="mt-3">
            <%= cl_image_tag message.image.key, class: "img-fluid rounded shadow-sm" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if Rails.env.development? %>
  <span class="float-end">
    Input tokens: <%= @input_tokens %> / Output tokens: <%= @output_tokens %> / Context window: <%= @context_window %>
  </span>
  <% end %>

  <%= form_with scope: :message, url: [@chat, Message.new], method: :post, local: true, html: { multipart: true } do |form| %>
    <div class="mb-4">
      <%= form.label :content, "Posez votre question :", class: "form-label fw-semibold" %>
      <%= form.text_area :content, class: "form-control shadow-sm", rows: 4, required: true, placeholder: "Exemple : Quel est lâ€™histoire du jersey de 1998 ?" %>
    </div>

    <div class="mb-4">
      <%= form.label :image, "Charger une image (optionnel)", class: "form-label fw-semibold" %>
      <%= form.file_field :image, class: "form-control shadow-sm" %>
    </div>

    <div class="d-grid">
      <%= form.submit "Envoyer", class: "btn btn-dark btn-lg animate-in delay-2" %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener("turbo:load", () => {
    const lastMessage = document.querySelector(".chat-thread .chat-message:last-child");
    if (lastMessage) {
      lastMessage.scrollIntoView({ behavior: "smooth" });
    }
  });
</script>
